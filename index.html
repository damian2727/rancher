<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Perfil RanchersLand con NFTs</title>
  <style>
    /* Mantengo estilos previos */
    body { font-family:sans-serif; max-width:800px; margin:auto; padding:2rem; background:#f4f4f4; }
    input, button { padding:0.5rem; font-size:1rem; }
    section { background:#fff; padding:1rem; margin-top:1rem; border-radius:8px; }
    ul.nft-list { list-style:none; padding:0; display:grid; grid-template-columns:repeat(auto-fill,128px); gap:1rem; }
    ul.nft-list li { text-align:center; }
    ul.nft-list img { width:100%; border-radius:4px; }
  </style>
</head>
<body>
  <h1>Perfil RanchersLand / WAX</h1>
  <input id="account" placeholder="ej: tzgru.wam" /><button id="btn">Consultar Perfil</button>
  <div id="msg">Ingresa tu cuenta .wam y presiona Consultar</div>
  <section id="tokens" style="display:none">
    <h2>üí∞ Tokens</h2><table><thead><tr><th>Token</th><th>Saldo</th></tr></thead><tbody id="tbody-tokens"></tbody></table>
  </section>
  <section id="nfts" style="display:none">
    <h2>üîó NFTs Equipados</h2><ul id="nft-list" class="nft-list"></ul>
  </section>
<script>
  const tokenIcons = {
    "RANCH":"https://i.postimg.cc/Y9JFyvxW/ranch.png",
    "FARM":"https://i.postimg.cc/XqJt7nHd/farm.png",
    "TOOL":"https://i.postimg.cc/j5cgfbmZ/tool.png",
    "RCOIN":"https://i.postimg.cc/zGnRwTz6/rcoin.png"
  };

  document.getElementById('btn').addEventListener('click', async () => {
    const acc = document.getElementById('account').value.trim();
    const msg = document.getElementById('msg');
    const secTokens = document.getElementById('tokens');
    const secNFTs = document.getElementById('nfts');
    const tbody = document.getElementById('tbody-tokens');
    const nftList = document.getElementById('nft-list');

    secTokens.style.display = secNFTs.style.display = "none";
    tbody.innerHTML = nftList.innerHTML = "";
    if (!/^[a-z1-5.]{1,12}\.wam$/.test(acc)) { msg.textContent = "‚ùå Cuenta inv√°lida"; return; }
    msg.textContent = "‚è≥ Consultando perfil...";

    try {
      let res = await fetch('https://wax.pink.gg/v1/chain/get_table_rows', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({json:true, code:'ranchersland', scope:'ranchersland', table:'accounts', limit:5000})
      });
      const data = await res.json();
      const row = data.rows.find(r => r.account === acc);
      if (!row) return msg.textContent = "‚ùå Perfil no encontrado.";

      // Mostrar tokens
      row.balances?.forEach(b => {
        const [amount,sym] = b.split(' ');
        const icon = tokenIcons[sym] || '';
        const tr = document.createElement('tr');
        tr.innerHTML = `<td><img src="${icon}" height=24>${sym}</td><td>${amount}</td>`;
        tbody.appendChild(tr);
      });
      secTokens.style.display = row.balances.length? 'block':'none';

      // Mostrar NFTs equipados
      if (Array.isArray(row.staked_nft) && row.staked_nft.length) {
        msg.textContent = "‚è≥ Cargando " + row.staked_nft.length + " NFT(s)...";
        for (const id of row.staked_nft) {
          try {
           let r2 = await fetch(`https://aa.wax.blacklusion.io/atomicassets/v1/assets/${id}`);
            let js = await r2.json();
            const asset = js.data;
            const img = asset.data.img || asset.mutable_data.img || '';
            const name = asset.name || '';
            const li = document.createElement('li');
            li.innerHTML = `<img src="${img}" alt="${name}"/><p>${name}</p>`;
            nftList.appendChild(li);
          } catch(e){ console.warn("NFT err:", id, e); }
        }
        secNFTs.style.display = 'block';
      }

      msg.textContent = `‚úÖ Perfil cargado para ${acc}`;

    } catch(e) {
      console.error(e);
      msg.textContent = `‚ùå Error: ${e.message}`;
    }
  });
</script>
</body>
</html>
