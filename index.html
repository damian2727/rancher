<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Perfil RanchersLand con NFTs</title>
  <style>
    /* Mantengo estilos previos */
    body { font-family:sans-serif; max-width:800px; margin:auto; padding:2rem; background:#f4f4f4; }
    input, button { padding:0.5rem; font-size:1rem; }
    section { background:#fff; padding:1rem; margin-top:1rem; border-radius:8px; }
    ul.nft-list { list-style:none; padding:0; display:grid; grid-template-columns:repeat(auto-fill,128px); gap:1rem; }
    ul.nft-list li { text-align:center; }
    ul.nft-list img { width:100%; border-radius:4px; }
  </style>
</head>
<body>
  <h1>Perfil RanchersLand / WAX</h1>
  <input id="account" placeholder="ej: tzgru.wam" /><button id="btn">Consultar Perfil</button>
  <div id="msg">Ingresa tu cuenta .wam y presiona Consultar</div>
  <section id="tokens" style="display:none">
    <h2>üí∞ Tokens</h2><table><thead><tr><th>Token</th><th>Saldo</th></tr></thead><tbody id="tbody-tokens"></tbody></table>
  </section>
  <section id="nfts" style="display:none">
    <h2>üîó NFTs Equipados</h2><ul id="nft-list" class="nft-list"></ul>
  </section>
<script>
const tokenIcons = {
  "RANCH": "https://raw.githubusercontent.com/wax-official/media-assets/main/token-icons/ranch.png",
  "FARM":  "https://raw.githubusercontent.com/wax-official/media-assets/main/token-icons/farm.png",
  "TOOL":  "https://raw.githubusercontent.com/wax-official/media-assets/main/token-icons/tool.png",
  "RCOIN": "https://raw.githubusercontent.com/wax-official/media-assets/main/token-icons/rcoin.png"
};


  document.getElementById('btn').addEventListener('click', async () => {
    const acc = document.getElementById('account').value.trim();
    const msg = document.getElementById('msg');
    const secTokens = document.getElementById('tokens');
    const secNFTs = document.getElementById('nfts');
    const tbody = document.getElementById('tbody-tokens');
    const nftList = document.getElementById('nft-list');

    secTokens.style.display = secNFTs.style.display = "none";
    tbody.innerHTML = nftList.innerHTML = "";
    if (!/^[a-z1-5.]{1,12}\.wam$/.test(acc)) { msg.textContent = "‚ùå Cuenta inv√°lida"; return; }
    msg.textContent = "‚è≥ Consultando perfil...";

    try {
      let res = await fetch('https://wax.pink.gg/v1/chain/get_table_rows', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({json:true, code:'ranchersland', scope:'ranchersland', table:'accounts', limit:5000})
      });
      const data = await res.json();
      const row = data.rows.find(r => r.account === acc);
      if (!row) return msg.textContent = "‚ùå Perfil no encontrado.";

      // Mostrar tokens
      row.balances?.forEach(b => {
        const [amount, sym] = b.split(' ');
       const icon = tokenIcons[sym] || 'https://via.placeholder.com/24';
       const tr = document.createElement('tr');
        tr.innerHTML = `
  <td>
    <img src="${icon}" alt="${sym}" height="24" style="vertical-align:middle; margin-right:6px;">
    ${sym}
  </td>
  <td>${amount}</td>
`;

        tbody.appendChild(tr);
      });
      secTokens.style.display = row.balances.length? 'block':'none';

      // Mostrar NFTs equipados
     // NUEVO: funci√≥n para cargar un NFT por ID
async function cargarNFT(asset_id) {
  try {
    const res = await fetch(`https://aa.wax.blacklusion.io/atomicassets/v1/assets/${asset_id}`);
    const json = await res.json();
    const asset = json.data;

    const name = asset.name || asset.data?.name || "NFT";
    const image = asset.data?.img || asset.template?.immutable_data?.img || "";

    // En este caso la imagen ya es URL completa (no es solo un hash)
    return {
      name: name,
      img: image || "https://i.postimg.cc/wTPccFbf/question.png"
    };
  } catch (e) {
    console.warn("Error al cargar NFT", asset_id, e);
    return null;
  }
}

// NFTs normales
if (Array.isArray(row.staked_nft) && row.staked_nft.length) {
  msg.textContent = `‚è≥ Cargando ${row.staked_nft.length} NFT(s)...`;

  for (const id of row.staked_nft) {
    const nft = await cargarNFT(id);
    if (!nft) continue;
    const li = document.createElement('li');
    li.innerHTML = `<img src="${nft.img}" alt="${nft.name}" /><p>${nft.name}</p>`;
    nftList.appendChild(li);
  }
  secNFTs.style.display = 'block';
}

// NUEVO: NFTs trabajadores
if (Array.isArray(row.staked_workers) && row.staked_workers.length) {
  const secWorkers = document.createElement('section');
  secWorkers.innerHTML = `<h2>üßë‚Äçüåæ Trabajadores Equipados</h2><ul class="nft-list" id="worker-list"></ul>`;
  document.body.appendChild(secWorkers);

  const workerList = secWorkers.querySelector('#worker-list');

  for (const id of row.staked_workers) {
    const nft = await cargarNFT(id);
    if (!nft) continue;
    const li = document.createElement('li');
    li.innerHTML = `<img src="${nft.img}" alt="${nft.name}" /><p>${nft.name}</p>`;
    workerList.appendChild(li);
  }
}

      msg.textContent = `‚úÖ Perfil cargado para ${acc}`;

    } catch(e) {
      console.error(e);
      msg.textContent = `‚ùå Error: ${e.message}`;
    }
  });
</script>
</body>
</html>
